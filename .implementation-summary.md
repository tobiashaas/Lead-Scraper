# Blue/Green Traffic Switching Implementation Summary

## Overview

Implemented deterministic blue/green traffic switching using nginx upstream symlink mechanism. This replaces the previous label-based approach with a concrete, auditable traffic routing system.

## Changes Made

### 1. Nginx Configuration Files

**Created `nginx/` directory with:**
- `upstream-blue.conf` - Defines upstream pointing to `kr-app-prod-blue:8000`
- `upstream-green.conf` - Defines upstream pointing to `kr-app-prod-green:8000`
- `upstream-active.conf` - Initial copy pointing to blue (will be managed as symlink in container)
- `README.md` - Configuration documentation and troubleshooting guide

**Modified `nginx.prod.conf`:**
- Replaced static upstream with `include /etc/nginx/conf.d/upstream-active.conf;`
- Updated all `proxy_pass` directives to use `http://api_upstream`
- Added comments explaining the symlink-based switching mechanism

### 2. Docker Compose Configuration

**Modified `docker-compose.prod.yml`:**
- Added volume mount: `./nginx:/etc/nginx/conf.d:rw`
- Enables read-write access for symlink management inside container
- Maintains existing mounts for `nginx.prod.conf` and SSL certificates

### 3. Deployment Script

**Modified `scripts/deployment/deploy.sh`:**

**In `switch_traffic()` function:**
- Determines active color from target container name
- Creates symlink inside nginx container: `ln -sf /etc/nginx/conf.d/upstream-{color}.conf /etc/nginx/conf.d/upstream-active.conf`
- Verifies symlink points to correct file with error handling
- Reloads nginx with failure detection
- Maintains label updates for observability

**In `rollback()` function:**
- Added nginx symlink rollback logic
- Switches symlink back to previous container's upstream
- Reloads nginx to restore traffic routing

### 4. Documentation

**Updated `scripts/deployment/README.md`:**
- Added "Blue-Green Traffic Switching" section explaining the mechanism
- Updated `deploy.sh` features to include symlink switching and verification
- Added nginx directory to deployment structure diagram
- Updated prerequisites to mention nginx configuration files

**Updated `docs/DEPLOYMENT.md`:**
- Enhanced "Blue-Green Deployment" section with traffic switching details
- Added "Traffic Switching Mechanism" subsection with implementation details
- Documented the auditable nature of the file-based approach
- Cross-referenced nginx and deployment documentation

**Created `nginx/README.md`:**
- Explained file structure and purpose
- Documented how the mechanism works
- Provided initial setup instructions
- Included verification commands
- Added troubleshooting section

## How It Works

1. **Deployment determines target color** (blue or green based on current active container)
2. **New container starts and passes health checks**
3. **Symlink is updated** inside nginx container to point to target upstream config
4. **Symlink is verified** to ensure it points to the correct file
5. **Nginx reloads** to apply new upstream configuration
6. **Traffic routes to new container** via the updated upstream
7. **Old container stops** after successful switch

## Rollback Mechanism

On deployment failure:
1. Target container is stopped and removed
2. Previous container is restarted if needed
3. Symlink switches back to previous upstream configuration
4. Nginx reloads to restore traffic routing
5. Labels updated for observability

## Verification

After deployment, verify the switch:

```bash
# Check which upstream is active
docker exec kr-nginx-prod readlink /etc/nginx/conf.d/upstream-active.conf

# Test health endpoint
curl http://<prod-host>/health

# Check container labels
docker inspect kr-app-prod-blue --format '{{.Config.Labels}}'
docker inspect kr-app-prod-green --format '{{.Config.Labels}}'
```

## Benefits

- **Deterministic**: Traffic routing based on explicit configuration files
- **Auditable**: Symlink state can be inspected at any time
- **Reliable**: Nginx honors upstream configuration, not Docker labels
- **Verifiable**: Deployment script confirms symlink points to correct file
- **Zero-downtime**: Nginx reload is seamless
- **Fast rollback**: Symlink switch + reload takes < 1 second

## Initial Setup Required

On first deployment to production, initialize the symlink inside the nginx container:

```bash
docker exec kr-nginx-prod ln -sf /etc/nginx/conf.d/upstream-blue.conf /etc/nginx/conf.d/upstream-active.conf
docker exec kr-nginx-prod nginx -s reload
```

This is a one-time setup. Subsequent deployments will manage the symlink automatically.

## Files Modified

- `nginx.prod.conf` - Updated to use include directive
- `docker-compose.prod.yml` - Added nginx directory mount
- `scripts/deployment/deploy.sh` - Implemented symlink switching logic
- `scripts/deployment/README.md` - Documented traffic switching
- `docs/DEPLOYMENT.md` - Enhanced deployment guide

## Files Created

- `nginx/upstream-blue.conf` - Blue upstream configuration
- `nginx/upstream-green.conf` - Green upstream configuration
- `nginx/upstream-active.conf` - Initial active configuration (copy)
- `nginx/README.md` - Nginx configuration documentation
